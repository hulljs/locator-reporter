<div class="leadership-container">

    <!-- ===================== HEADER ===================== -->
    <header class="leadership-header">
        <div class="header-left">
            <h1 class="gradient-text">Leadership Dashboard</h1>
            <p class="header-subtitle">Enterprise program overview — projects, personnel, budgets, and reports</p>
        </div>
        <div class="header-right">
            <!-- Map View Icon -->
            <a routerLink="/" class="icon-btn" title="Map View">
                <i class="material-icons">map</i>
            </a>

            <!-- Notification Icon -->
            <button class="icon-btn notification-trigger" (click)="toggleNotifications()" title="Notifications">
                <i class="material-icons">notifications</i>
                <span class="notification-badge" *ngIf="unreadCount > 0">{{ unreadCount }}</span>
            </button>

            <div class="divider-vertical"></div>

            <!-- User Menu & Actions Dropdown -->
            <div class="user-dropdown" *ngIf="authService.isLoggedIn">
                <button class="user-trigger">
                    <div class="user-avatar">{{ getInitials() }}</div>
                    <div class="user-info-text">
                        <span class="user-name">{{ authService.currentUser?.name }}</span>
                        <span class="user-role-label">{{ authService.currentUser?.role }}</span>
                    </div>
                    <i class="material-icons chevron">expand_more</i>
                </button>

                <div class="user-menu">
                    <div class="menu-header">
                        <span>Dashboard Actions</span>
                    </div>
                    <button class="menu-item" (click)="exportProjectsCsv()">
                        <i class="material-icons">table_chart</i> Export Projects CSV
                    </button>
                    <button class="menu-item" (click)="exportPeopleCsv()">
                        <i class="material-icons">people</i> Export People CSV
                    </button>
                    <button class="menu-item" (click)="printDashboard()">
                        <i class="material-icons">print</i> Print View
                    </button>

                    <div class="menu-divider"></div>

                    <button class="menu-item danger" (click)="logout()">
                        <i class="material-icons">logout</i> Log Out
                    </button>
                </div>
            </div>

            <!-- Login (if logged out) -->
            <a routerLink="/login" class="header-btn login-btn" *ngIf="!authService.isLoggedIn">
                <i class="material-icons">login</i> Log In
            </a>
        </div>
    </header>

    <!-- ===================== NOTIFICATION PANEL ===================== -->
    <div class="notification-panel glass-panel" *ngIf="showNotifications">
        <div class="notification-panel-header">
            <h3>Notifications</h3>
            <button class="text-btn" (click)="markAllNotificationsRead()" *ngIf="unreadCount > 0">
                Mark all read
            </button>
        </div>
        <div class="notification-list">
            <div *ngFor="let n of notifications" class="notification-item" [class.unread]="!n.is_read">
                <div class="notification-icon">
                    <i class="material-icons">{{ getNotificationIcon(n.type) }}</i>
                </div>
                <div class="notification-content">
                    <span class="notification-title">{{ n.title }}</span>
                    <span class="notification-message">{{ n.message }}</span>
                    <span class="notification-time">{{ timeAgo(n.created_at) }}</span>
                </div>
                <button class="notification-mark-btn" *ngIf="!n.is_read" (click)="markNotificationRead(n)">
                    <i class="material-icons">check_circle</i>
                </button>
            </div>
            <div *ngIf="notifications.length === 0" class="empty-state">
                No notifications.
            </div>
        </div>
    </div>

    <!-- ===================== TAB NAVIGATION ===================== -->
    <nav class="tab-nav">
        <button class="tab-btn" [class.active]="activeTab === 'overview'" (click)="setTab('overview')">
            <i class="material-icons">dashboard</i> Overview
        </button>
        <button class="tab-btn" [class.active]="activeTab === 'projects'" (click)="setTab('projects')">
            <i class="material-icons">assignment</i> Projects
        </button>
        <button class="tab-btn" [class.active]="activeTab === 'people'" (click)="setTab('people')">
            <i class="material-icons">people</i> Personnel
        </button>
        <button class="tab-btn" [class.active]="activeTab === 'heatmap'" (click)="setTab('heatmap')">
            <i class="material-icons">grid_on</i> Heatmap
        </button>
        <button class="tab-btn" [class.active]="activeTab === 'activity'" (click)="setTab('activity')">
            <i class="material-icons">history</i> Activity
        </button>
        <button class="tab-btn" [class.active]="activeTab === 'charts'" (click)="setTab('charts')">
            <i class="material-icons">bar_chart</i> Charts
        </button>
        <button class="tab-btn" [class.active]="activeTab === 'reports'" (click)="setTab('reports')">
            <i class="material-icons">description</i> Reports
        </button>
    </nav>

    <!-- ===================== TAB CONTENT ===================== -->
    <main class="tab-content">

        <!-- ========== OVERVIEW TAB ========== -->
        <section *ngIf="activeTab === 'overview'" class="fade-in">

            <!-- Summary Cards -->
            <div class="summary-grid" *ngIf="summary">
                <div class="summary-card glass-panel">
                    <div class="summary-icon locations"><i class="material-icons">place</i></div>
                    <div class="summary-info">
                        <div class="summary-value">{{ summary.total_locations }}</div>
                        <div class="summary-label">Locations</div>
                    </div>
                </div>
                <div class="summary-card glass-panel">
                    <div class="summary-icon people"><i class="material-icons">people</i></div>
                    <div class="summary-info">
                        <div class="summary-value">{{ summary.total_people }}</div>
                        <div class="summary-label">Personnel</div>
                    </div>
                </div>
                <div class="summary-card glass-panel">
                    <div class="summary-icon projects"><i class="material-icons">assignment</i></div>
                    <div class="summary-info">
                        <div class="summary-value">{{ summary.total_projects }}</div>
                        <div class="summary-label">Projects</div>
                    </div>
                </div>
                <div class="summary-card glass-panel">
                    <div class="summary-icon reports"><i class="material-icons">description</i></div>
                    <div class="summary-info">
                        <div class="summary-value">{{ summary.total_reports }}</div>
                        <div class="summary-label">Reports</div>
                    </div>
                </div>
                <div class="summary-card glass-panel accent-warning">
                    <div class="summary-icon at-risk"><i class="material-icons">warning</i></div>
                    <div class="summary-info">
                        <div class="summary-value">{{ summary.at_risk_count }}</div>
                        <div class="summary-label">At Risk</div>
                    </div>
                </div>
                <div class="summary-card glass-panel accent-danger">
                    <div class="summary-icon behind"><i class="material-icons">error</i></div>
                    <div class="summary-info">
                        <div class="summary-value">{{ summary.behind_count }}</div>
                        <div class="summary-label">Behind</div>
                    </div>
                </div>
                <div class="summary-card glass-panel accent-danger">
                    <div class="summary-icon overcommitted"><i class="material-icons">person_off</i></div>
                    <div class="summary-info">
                        <div class="summary-value">{{ summary.overcommitted_count }}</div>
                        <div class="summary-label">Overcommitted</div>
                    </div>
                </div>
                <div class="summary-card glass-panel">
                    <div class="summary-icon budget"><i class="material-icons">account_balance</i></div>
                    <div class="summary-info">
                        <div class="summary-value">{{ formatCurrency(summary.total_budget_actual) }} / {{
                            formatCurrency(summary.total_budget_planned) }}</div>
                        <div class="summary-label">Budget (Actual / Planned)</div>
                    </div>
                </div>
            </div>

            <!-- Projects by Location -->
            <div class="section-header">
                <h2>Projects by Location</h2>
                <button class="text-btn" (click)="setTab('projects')">View All</button>
            </div>
            <div class="location-cards-grid">
                <div *ngFor="let loc of projectsByLocation" class="location-card glass-panel">
                    <div class="location-card-header">
                        <h3>{{ loc.location_name }}</h3>
                    </div>
                    <div class="location-stats-row">
                        <span class="stat">{{ loc.project_count }} projects</span>
                        <span class="stat highlight">{{ loc.top_5_count }} top 5</span>
                        <span class="stat warning" *ngIf="loc.at_risk_count > 0">{{ loc.at_risk_count }} at risk</span>
                    </div>
                    <div class="location-budget-bar">
                        <span class="budget-label">Budget: {{ formatCurrency(loc.total_budget_actual) }} / {{
                            formatCurrency(loc.total_budget_planned) }}</span>
                    </div>
                    <ul class="project-quick-list">
                        <li *ngFor="let proj of loc.projects?.slice(0, 3)">
                            <span class="project-name">{{ proj.name }}</span>
                            <span class="status-badge" [ngClass]="getStatusClass(proj.status)">
                                <span class="status-dot"></span> {{ proj.status }}
                            </span>
                            <div class="progress-bar-mini">
                                <div class="progress-bar-fill" [style.width.%]="proj.percent_complete"></div>
                            </div>
                        </li>
                    </ul>
                    <div *ngIf="loc.projects && loc.projects.length > 3" class="more-indicator">
                        +{{ loc.projects.length - 3 }} more
                    </div>
                </div>
            </div>

            <!-- Workload Alerts -->
            <div class="section-header">
                <h2>Workload Alerts</h2>
                <button class="text-btn" (click)="setTab('people')">View All</button>
            </div>
            <div class="workload-alerts-grid">
                <ng-container *ngFor="let w of workload">
                    <div *ngIf="w.total_allocation > 100" class="workload-card alert-card glass-panel"
                        (click)="openManageModal(w)">
                        <div class="card-top-strip danger"></div>
                        <div class="workload-header">
                            <div class="person-avatar-lg danger">
                                {{ getPersonInitials(w.name) }}
                            </div>
                            <div class="workload-info">
                                <div class="name-row">
                                    <span class="person-name-lg">{{ w.name }}</span>
                                    <span class="total-badge danger">{{ w.total_allocation }}%</span>
                                </div>
                                <span class="person-role">{{ w.role }}</span>
                            </div>
                            <div class="edit-action">
                                <i class="material-icons">edit</i>
                            </div>
                        </div>

                        <div class="workload-meter-container">
                            <div class="meter-label">
                                <span>Utilization</span>
                                <span class="meter-val danger">{{ w.total_allocation }}%</span>
                            </div>
                            <div class="meter-track">
                                <div class="meter-fill danger-gradient" [style.width.%]="100"></div>
                                <!-- Over 100 visual -->
                            </div>
                            <div class="over-capacity-msg">
                                <i class="material-icons">warning</i> {{ w.total_allocation - 100 }}% over capacity
                            </div>
                        </div>

                        <div class="assignments-list-compact">
                            <div *ngFor="let a of w.assignments" class="assignment-chip">
                                <span class="chip-loc">{{ a.location_name }}</span>
                                <span class="chip-role">{{ a.role_at_location }}</span>
                                <span class="chip-val">{{ a.allocation_pct }}%</span>
                            </div>
                        </div>
                    </div>
                </ng-container>
                <div *ngIf="(workload | keyvalue).length === 0" class="empty-state">
                    No alerts.
                </div>
            </div>

        </section>

        <!-- ========== PROJECTS TAB ========== -->
        <section *ngIf="activeTab === 'projects'" class="fade-in">

            <div class="section-actions">
                <button class="action-btn" (click)="exportProjectsCsv()">
                    <i class="material-icons">download</i> Export CSV
                </button>
            </div>

            <div *ngFor="let loc of projectsByLocation" class="detail-card glass-panel">
                <div class="detail-card-header" (click)="toggleLocation(loc.location_id)">
                    <div class="detail-card-title">
                        <div class="loc-icon-box">
                            <i class="material-icons">place</i>
                        </div>
                        <h3>{{ loc.location_name }}</h3>
                    </div>
                    <div class="detail-card-summary">
                        <div class="mini-stat">
                            <span class="val">{{ loc.project_count }}</span>
                            <span class="lbl">Projects</span>
                        </div>
                        <div class="mini-stat" *ngIf="loc.at_risk_count > 0">
                            <span class="val warning-text">{{ loc.at_risk_count }}</span>
                            <span class="lbl warning-text">At Risk</span>
                        </div>
                        <div class="mini-stat budget">
                            <span class="val">{{ formatCurrency(loc.total_budget_actual) }}</span>
                            <span class="lbl">of {{ formatCurrency(loc.total_budget_planned) }}</span>
                        </div>
                        <i class="material-icons expand-icon">
                            {{ isExpanded(loc.location_id) ? 'expand_less' : 'expand_more' }}
                        </i>
                    </div>
                </div>
                <div class="detail-card-body" *ngIf="isExpanded(loc.location_id)">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Status</th>
                                <th>Phase</th>
                                <th>% Complete</th>
                                <th>Budget</th>
                                <th>Top 5</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let proj of loc.projects">
                                <td class="cell-name">{{ proj.name }}</td>
                                <td>
                                    <span class="status-badge" [ngClass]="getStatusClass(proj.status)">
                                        <span class="status-dot"></span> {{ proj.status }}
                                    </span>
                                </td>
                                <td>{{ proj.phase }}</td>
                                <td>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill" [style.width.%]="proj.percent_complete"></div>
                                        <span class="progress-label">{{ proj.percent_complete }}%</span>
                                    </div>
                                </td>
                                <td class="cell-budget">
                                    <span class="budget-planned">{{ formatCurrency(proj.budget_planned) }}</span>
                                    <span class="budget-separator">/</span>
                                    <span class="budget-actual">{{ formatCurrency(proj.budget_actual) }}</span>
                                </td>
                                <td>
                                    <span *ngIf="proj.is_top_5" class="top5-badge">Top 5</span>
                                    <span *ngIf="!proj.is_top_5" class="standard-badge">Standard</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </section>

        <!-- ========== PERSONNEL TAB ========== -->
        <section *ngIf="activeTab === 'people'" class="fade-in">

            <div class="section-actions">
                <button class="action-btn" (click)="exportPeopleCsv()">
                    <i class="material-icons">download</i> Export CSV
                </button>
            </div>

            <!-- Workload Overview -->
            <div class="section-header">
                <h2>Workload Overview</h2>
            </div>
            <div class="workload-grid">
                <div *ngFor="let w of workload" class="workload-card glass-panel"
                    [class.over]="w.total_allocation > 100" (click)="openManageModal(w)">
                    <div class="workload-header">
                        <div class="person-avatar-lg" [ngClass]="{
                            'danger': w.total_allocation > 100,
                            'warning': w.total_allocation >= 80 && w.total_allocation <= 100,
                            'success': w.total_allocation < 80
                        }">
                            {{ getPersonInitials(w.name) }}
                        </div>
                        <div class="workload-info">
                            <div class="name-row">
                                <span class="person-name-lg">{{ w.name }}</span>
                                <span class="total-badge" [ngClass]="{
                                    'danger': w.total_allocation > 100,
                                    'warning': w.total_allocation >= 80 && w.total_allocation <= 100,
                                    'success': w.total_allocation < 80
                                }">{{ w.total_allocation }}%</span>
                            </div>
                            <span class="person-role">{{ w.role }} — {{ w.organization }}</span>
                        </div>
                        <div class="edit-action">
                            <i class="material-icons">edit</i>
                        </div>
                    </div>

                    <div class="workload-meter-container">
                        <div class="meter-track">
                            <div class="meter-fill"
                                [style.width.%]="w.total_allocation > 100 ? 100 : w.total_allocation" [ngClass]="{
                                    'danger-gradient': w.total_allocation > 100,
                                    'warning-gradient': w.total_allocation >= 80 && w.total_allocation <= 100,
                                    'success-gradient': w.total_allocation < 80
                                  }"></div>
                        </div>
                    </div>

                    <div class="assignments-list-compact">
                        <div *ngFor="let a of w.assignments" class="assignment-chip">
                            <div class="chip-row">
                                <span class="chip-loc">{{ a.location_name }}</span>
                                <span class="chip-val">{{ a.allocation_pct }}%</span>
                            </div>
                            <span class="chip-role-sub">{{ a.role_at_location }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- By Location -->
            <div class="section-header">
                <h2>By Location</h2>
            </div>
            <div *ngFor="let loc of peopleByLocation" class="detail-card glass-panel">
                <div class="detail-card-header" (click)="toggleLocation(loc.location_id + 1000)">
                    <div class="detail-card-title">
                        <i class="material-icons">place</i>
                        <h3>{{ loc.location_name }}</h3>
                    </div>
                    <div class="detail-card-summary">
                        <span class="stat">{{ loc.people_count }} personnel</span>
                        <span class="stat">Total allocation: {{ loc.total_allocation }}%</span>
                        <i class="material-icons expand-icon">
                            {{ isExpanded(loc.location_id + 1000) ? 'expand_less' : 'expand_more' }}
                        </i>
                    </div>
                </div>
                <div class="detail-card-body" *ngIf="isExpanded(loc.location_id + 1000)">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Organization</th>
                                <th>Role (Global)</th>
                                <th>Role (At Location)</th>
                                <th>Allocation</th>
                                <th>Email</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let p of loc.people">
                                <td class="cell-name">{{ p.person_name }}</td>
                                <td>{{ p.organization }}</td>
                                <td>{{ p.person_role }}</td>
                                <td>{{ p.role_at_location }}</td>
                                <td>
                                    <span class="allocation-badge">{{ p.allocation_pct }}%</span>
                                </td>
                                <td class="cell-email">{{ p.email }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </section>

        <!-- ========== HEATMAP TAB ========== -->
        <section *ngIf="activeTab === 'heatmap'" class="fade-in">

            <div class="section-header">
                <h2>Location Health Heatmap</h2>
            </div>

            <div class="heatmap-table-wrapper glass-panel">
                <table class="heatmap-table">
                    <thead>
                        <tr>
                            <th class="heatmap-location-col">Location</th>
                            <th>Budget Health</th>
                            <th>Avg Completion</th>
                            <th>At Risk + Behind</th>
                            <th>On Track</th>
                            <th>Complete</th>
                            <th>Staff Count</th>
                            <th>Total Allocation</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let h of heatmap">
                            <td class="heatmap-location-cell">{{ h.location_name }}</td>
                            <td>
                                <span class="heatmap-cell" [ngClass]="getHeatmapColor(h.budget_ratio, 'budget')">
                                    {{ (h.budget_ratio * 100).toFixed(0) }}%
                                </span>
                            </td>
                            <td>
                                <span class="heatmap-cell" [ngClass]="getHeatmapColor(h.avg_completion, 'schedule')">
                                    {{ h.avg_completion.toFixed(0) }}%
                                </span>
                            </td>
                            <td>
                                <span class="heatmap-cell" [ngClass]="getHeatmapColor(h.at_risk + h.behind, 'status')">
                                    {{ h.at_risk + h.behind }}
                                </span>
                            </td>
                            <td>
                                <span class="heatmap-cell heat-neutral">{{ h.on_track }}</span>
                            </td>
                            <td>
                                <span class="heatmap-cell heat-neutral">{{ h.complete }}</span>
                            </td>
                            <td>
                                <span class="heatmap-cell heat-neutral">{{ h.staff_count }}</span>
                            </td>
                            <td>
                                <span class="heatmap-cell heat-neutral">{{ h.total_staff_allocation }}%</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Legend -->
            <div class="heatmap-legend glass-panel">
                <h4>Legend</h4>
                <div class="legend-items">
                    <div class="legend-item">
                        <span class="legend-swatch heat-green"></span>
                        <span>Green — Healthy / On target</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-swatch heat-yellow"></span>
                        <span>Yellow — Caution / Approaching threshold</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-swatch heat-red"></span>
                        <span>Red — Critical / Over threshold</span>
                    </div>
                </div>
            </div>

        </section>

        <!-- ========== ACTIVITY TAB ========== -->
        <section *ngIf="activeTab === 'activity'" class="fade-in">

            <div class="section-header">
                <h2>Recent Activity</h2>
            </div>

            <div class="activity-list">
                <div *ngFor="let entry of activity" class="activity-row glass-panel">
                    <div class="activity-row-main">
                        <div class="activity-type-icon" [ngClass]="getActivityClass(entry.action)">
                            <i class="material-icons">{{ getActivityIcon(entry.action) }}</i>
                        </div>
                        <div class="activity-info">
                            <span class="activity-action">
                                <span class="entity-badge">{{ entry.entity_type }}</span> {{ entry.action }}
                            </span>
                            <span class="activity-details">{{ entry.details }}</span>
                        </div>
                    </div>
                    <div class="activity-row-meta">
                        <span><i class="material-icons meta-icon">person</i> {{ entry.user_name }}</span>
                        <span><i class="material-icons meta-icon">schedule</i> {{ timeAgo(entry.created_at) }}</span>
                    </div>
                </div>
                <div *ngIf="activity.length === 0" class="empty-state">
                    No recent activity.
                </div>
            </div>

        </section>

        <!-- ========== CHARTS TAB ========== -->
        <section *ngIf="activeTab === 'charts'" class="fade-in">

            <div class="section-header">
                <h2>Analytics Charts</h2>
            </div>

            <div class="charts-grid">
                <div class="chart-container glass-panel">
                    <canvas #budgetChart></canvas>
                </div>
                <div class="chart-container glass-panel">
                    <canvas #statusChart></canvas>
                </div>
                <div class="chart-container glass-panel">
                    <canvas #phaseChart></canvas>
                </div>
                <div class="chart-container glass-panel">
                    <canvas #staffingChart></canvas>
                </div>
            </div>

        </section>

        <!-- ========== REPORTS TAB ========== -->
        <section *ngIf="activeTab === 'reports'" class="fade-in">

            <!-- Search / Filters -->
            <div class="filters-bar glass-panel">
                <div class="filter-group">
                    <i class="material-icons">search</i>
                    <input type="text" [(ngModel)]="reportSearch" placeholder="Search reports..."
                        (keyup.enter)="searchReports()" class="filter-input">
                </div>
                <div class="filter-group">
                    <select [(ngModel)]="reportTypeFilter" (change)="searchReports()" class="filter-select">
                        <option value="">All Types</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="inspection">Inspection</option>
                        <option value="sitrep">Sitrep</option>
                        <option value="assessment">Assessment</option>
                        <option value="general">General</option>
                    </select>
                </div>
                <div class="filter-group">
                    <select [(ngModel)]="reportLocationFilter" (change)="searchReports()" class="filter-select">
                        <option value="">All Locations</option>
                        <option *ngFor="let loc of projectsByLocation" [value]="loc.location_id">
                            {{ loc.location_name }}
                        </option>
                    </select>
                </div>
                <button class="clear-btn" (click)="clearFilters()">
                    <i class="material-icons">clear</i> Clear
                </button>
            </div>

            <!-- Reports List -->
            <div class="reports-list">
                <div *ngFor="let report of reports" class="report-row glass-panel" (click)="viewReport(report)">
                    <div class="report-row-main">
                        <span class="report-type-badge" [ngClass]="getReportTypeBadgeClass(report.report_type)">
                            {{ report.report_type }}
                        </span>
                        <span class="report-title">{{ report.title }}</span>
                    </div>
                    <div class="report-row-meta">
                        <span><i class="material-icons meta-icon">place</i> {{ report.location_name }}</span>
                        <span><i class="material-icons meta-icon">person</i> {{ report.author_name || 'Unknown'
                            }}</span>
                        <span><i class="material-icons meta-icon">calendar_today</i> {{ formatDate(report.report_date)
                            }}</span>
                    </div>
                </div>
                <div *ngIf="reports.length === 0" class="empty-state">
                    No reports found matching your filters.
                </div>
            </div>

        </section>

    </main>

    <!-- ===================== REPORT DETAIL MODAL ===================== -->
    <div class="modal-overlay" *ngIf="selectedReport" (click)="closeReport()">
        <div class="modal-content glass-panel" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <div>
                    <span class="report-type-badge" [ngClass]="getReportTypeBadgeClass(selectedReport.report_type)">
                        {{ selectedReport.report_type }}
                    </span>
                    <h2>{{ selectedReport.title }}</h2>
                </div>
                <button class="close-btn" (click)="closeReport()">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div class="modal-meta">
                <span><i class="material-icons meta-icon">place</i> {{ selectedReport.location_name }}</span>
                <span><i class="material-icons meta-icon">person</i> {{ selectedReport.author_name || 'Unknown'
                    }}</span>
                <span><i class="material-icons meta-icon">calendar_today</i> {{ formatDate(selectedReport.report_date)
                    }}</span>
            </div>
            <div class="modal-body">
                {{ selectedReport.body }}
            </div>
        </div>
    </div>

    <!-- ===================== MANAGE WORKLOAD MODAL ===================== -->
    <div class="modal-overlay" *ngIf="selectedPerson" (click)="closeManageModal()">
        <div class="modal-content glass-panel" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <div>
                    <h2>Manage Workload</h2>
                    <p class="modal-subtitle">{{ selectedPerson.name }} — {{ selectedPerson.role }}</p>
                </div>
                <button class="close-btn" (click)="closeManageModal()">
                    <i class="material-icons">close</i>
                </button>
            </div>

            <div class="modal-body">

                <!-- New Assignment Form -->
                <div class="glass-panel inner-panel mb-4">
                    <h4 class="h5 mb-3">Add New Assignment</h4>
                    <div class="form-row">
                        <select [(ngModel)]="newAssignment.location_id" class="form-input flex-grow">
                            <option value="" disabled selected>Select Location</option>
                            <option *ngFor="let loc of availableLocations" [value]="loc.id">{{ loc.name }}</option>
                        </select>
                        <input type="text" [(ngModel)]="newAssignment.role_at_location" placeholder="Role (e.g. Lead)"
                            class="form-input flex-grow">
                        <input type="number" [(ngModel)]="newAssignment.allocation_pct" placeholder="Pct %"
                            class="form-input w-24">
                        <button class="action-btn" (click)="addAssignment()" [disabled]="!newAssignment.location_id">
                            <i class="material-icons">add</i> Add
                        </button>
                    </div>
                </div>

                <!-- Current Assignments List -->
                <h4 class="h5 mb-3">Current Assignments</h4>
                <div class="assignments-table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Location</th>
                                <th>Role</th>
                                <th>Allocation %</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let a of manageAssignments">
                                <td>{{ a.location_name }}</td>
                                <td>
                                    <input type="text" [(ngModel)]="a.role_at_location" class="table-input"
                                        (blur)="updateAssignmentPct(a)">
                                </td>
                                <td>
                                    <input type="number" [(ngModel)]="a.allocation_pct" class="table-input w-24"
                                        (blur)="updateAssignmentPct(a)">
                                </td>
                                <td class="actions-cell">
                                    <button class="icon-btn danger-hover" (click)="removeAssignment(a.id)">
                                        <i class="material-icons">delete</i>
                                    </button>
                                </td>
                            </tr>
                            <tr *ngIf="manageAssignments.length === 0">
                                <td colspan="4" class="empty-state-sm">No active assignments.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt-4 flex justify-between items-center border-t border-glass pt-4">
                    <span class="text-secondary">Expected Total Allocation:</span>
                    <span [ngClass]="getWorkloadClass(selectedPerson.total_allocation)" class="font-bold text-lg">{{
                        selectedPerson.total_allocation }}%</span>
                </div>

            </div>
        </div>
    </div>

</div>